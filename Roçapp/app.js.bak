// App State
const state = {
    tasks: [],
    routines: [],
    projects: [], // { id, name, emoji }
    currentProject: 'all', // 'all' or projectId
    viewDate: new Date() // Initialize with Today
};

// DOM Elements
const elements = {
    dateDisplay: document.getElementById('dateDisplay'),
    moonPhaseDisplay: document.getElementById('moonPhaseDisplay'),
    moonTipDisplay: document.getElementById('moonTipDisplay'),
    prevMoonBtn: document.getElementById('prevMoonBtn'),
    nextMoonBtn: document.getElementById('nextMoonBtn'),

    // Lists & Containers
    projectTabs: document.getElementById('projectTabs'),
    todoList: document.getElementById('todoList'),
    sectionTitle: document.getElementById('sectionTitle'),
    taskCount: document.getElementById('taskCount'),

    // Buttons
    addBtn: document.getElementById('addBtn'),

    // Modals
    modal: document.getElementById('taskModal'), // Task Modal
    closeModal: document.getElementById('closeModal'),

    projectModal: document.getElementById('projectModal'),
    closeProjectModal: document.getElementById('closeProjectModal'),

    moonModal: document.getElementById('moonModal'),
    closeMoonModal: document.getElementById('closeMoonModal'),
    moonModalTitle: document.getElementById('moonModalTitle'),
    moonModalContent: document.getElementById('moonModalContent'),

    guideModal: document.getElementById('guideModal'),
    closeGuideModal: document.getElementById('closeGuideModal'),
    guideModalTitle: document.getElementById('guideModalTitle'),
    guideModalContent: document.getElementById('guideModalContent'),

    // Forms
    taskForm: document.getElementById('taskForm'),
    projectForm: document.getElementById('projectForm'),

    inputs: {
        title: document.getElementById('taskTitle'),
        desc: document.getElementById('taskDesc'),
        date: document.getElementById('taskDate'),
        priority: document.getElementById('taskPriority'),
        freq: document.getElementById('taskFreq'),
        project: document.getElementById('taskProject'),

        // Project Form
        projName: document.getElementById('projName'),
    }
};

let selectedEmoji = 'üå±';

// Initialization
function init() {
    try {
        if (window.logToScreen) window.logToScreen('Iniciando App...');

        loadData();
        if (window.logToScreen) window.logToScreen('Dados Carregados.');

        migrateData(); // Ensure defaults
        if (window.logToScreen) window.logToScreen('Migra√ß√£o Conclu√≠da.');

        processRoutines();
        if (window.logToScreen) window.logToScreen('Rotinas Processadas.');

        setupEventListeners();
        if (window.logToScreen) window.logToScreen('Eventos Configurados.');

        renderDate();
        renderProjects();
        renderTasks();
        if (window.logToScreen) window.logToScreen('Interface Renderizada com Sucesso!');

    } catch (e) {
        if (window.logToScreen) window.logToScreen('ERRO FATAL: ' + e.message);
        alert('Erro no App: ' + e.message);
    }
}

// Data Management
function loadData() {
    const savedTasks = localStorage.getItem('rocapp_tasks');
    const savedRoutines = localStorage.getItem('rocapp_routines');
    const savedProjects = localStorage.getItem('rocapp_projects');

    if (savedTasks) state.tasks = JSON.parse(savedTasks);
    if (savedRoutines) state.routines = JSON.parse(savedRoutines);
    if (savedProjects) state.projects = JSON.parse(savedProjects);
}

function saveData() {
    localStorage.setItem('rocapp_tasks', JSON.stringify(state.tasks));
    localStorage.setItem('rocapp_routines', JSON.stringify(state.routines));
    localStorage.setItem('rocapp_projects', JSON.stringify(state.projects));
    renderTasks(); // Re-render tasks to reflect changes
}

function migrateData() {
    // 1. Ensure at least one project exists
    if (state.projects.length === 0) {
        const defaultProj = { id: 1, name: 'Geral', emoji: 'üè°' };
        state.projects.push(defaultProj);
    }

    let changed = false;
    const defaultId = state.projects[0].id;

    // 2. Assign tasks without project to first project
    state.tasks.forEach(t => {
        if (!t.projectId) {
            t.projectId = defaultId;
            changed = true;
        }
    });

    // 3. Backfill Frequency for colors (Migration)
    state.tasks.forEach(t => {
        if (t.fromRoutine && !t.frequency) {
            const r = state.routines.find(rout => rout.id === t.routineId);
            if (r) {
                t.frequency = r.frequency;
                changed = true;
            }
        }
    });

    if (changed) saveData();
}

// Helper for Local Date String (YYYY-MM-DD)
// Fixes bug where late night usage (e.g. 22:00 Brazil) acts like tomorrow (UTC)
function getLocalISODate(date) {
    const d = new Date(date);
    const offset = d.getTimezoneOffset() * 60000;
    const local = new Date(d.getTime() - offset);
    return local.toISOString().split('T')[0];
}

// Routine Logic
function processRoutines() {
    // Generate tasks up to 90 days in the future so user can plan ahead
    const today = new Date();
    const futureLimit = new Date();
    futureLimit.setDate(today.getDate() + 90);
    const limitStr = getLocalISODate(futureLimit);

    const todayStr = getLocalISODate(today);
    let changed = false;

    state.routines.forEach(routine => {
        if (!routine.nextRun) {
            routine.nextRun = routine.lastGenerated ? todayStr : todayStr;
        }
        if (!routine.projectId) routine.projectId = state.projects[0].id;

        let safety = 0;
        // Check against FUTURE limit, not just today
        while (routine.nextRun <= limitStr && safety < 100) {
            safety++;

            const alreadyExists = state.tasks.some(t =>
                t.fromRoutine &&
                t.routineId === routine.id &&
                t.date === routine.nextRun
            );

            if (!alreadyExists) {
                state.tasks.push({
                    id: Date.now() + Math.random(),
                    title: routine.title,
                    description: routine.description,
                    date: routine.nextRun,
                    priority: 'normal',
                    completed: false,
                    fromRoutine: true,
                    routineId: routine.id,
                    projectId: routine.projectId,
                    frequency: routine.frequency // Pass frequency for styling
                });
                changed = true;
            }

            // Calculate next date
            let currentRunDate = new Date(routine.nextRun + 'T12:00:00');

            if (routine.frequency === 'daily') {
                currentRunDate.setDate(currentRunDate.getDate() + 1);
            } else if (routine.frequency === 'weekly') {
                if (routine.daysOfWeek && routine.daysOfWeek.length > 0) {
                    let found = false;
                    // Find next requested day (max 7 day lookahead)
                    for (let i = 1; i <= 7; i++) {
                        currentRunDate.setDate(currentRunDate.getDate() + 1);
                        if (routine.daysOfWeek.includes(currentRunDate.getDay())) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) currentRunDate.setDate(currentRunDate.getDate() + 7);
                } else {
                    currentRunDate.setDate(currentRunDate.getDate() + 7);
                }
            } else if (routine.frequency === 'monthly') {
                currentRunDate.setMonth(currentRunDate.getMonth() + 1);
            } else if (routine.frequency === 'quarterly') {
                currentRunDate.setMonth(currentRunDate.getMonth() + 3);
            }
            routine.nextRun = currentRunDate.toISOString().split('T')[0];
            changed = true;
        }
    });

    if (changed) saveData();
}

// Render Functions

function renderProjects() {
    elements.projectTabs.innerHTML = '';

    // "Geral" Pill (All Projects)
    const allBtn = document.createElement('button');
    allBtn.className = `pill-btn ${state.currentProject === 'all' ? 'active' : ''}`;
    allBtn.textContent = 'Geral';
    allBtn.onclick = () => { state.currentProject = 'all'; renderProjects(); renderTasks(); };
    elements.projectTabs.appendChild(allBtn);

    // Project Pills
    state.projects.filter(p => p.name !== 'Geral').forEach(p => {
        const btn = document.createElement('button');
        btn.className = `pill-btn ${state.currentProject === p.id ? 'active' : ''}`;
        btn.textContent = `${p.emoji} ${p.name}`;
        btn.onclick = () => { state.currentProject = p.id; renderProjects(); renderTasks(); };
        elements.projectTabs.appendChild(btn);
    });

    // Add Project Button
    const addBtn = document.createElement('button');
    addBtn.className = 'pill-btn add-project-btn';
    addBtn.textContent = '+ Novo';
    addBtn.onclick = () => toggleProjectModal(true);
    elements.projectTabs.appendChild(addBtn);

    // Update Modal Select
    updateProjectSelect();
}

function updateProjectSelect() {
    elements.inputs.project.innerHTML = '';
    state.projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.emoji} ${p.name}`;
        if (state.currentProject !== 'all' && state.currentProject === p.id) {
            opt.selected = true;
        }
        elements.inputs.project.appendChild(opt);
    });
}

function renderTasks() {
    const viewDateStr = getLocalISODate(state.viewDate);
    const isProjectView = state.currentProject !== 'all';

    // Filter Logic
    const visibleTasks = state.tasks.filter(t => {
        // If specific Project: Match Project ID + Show ALL Dates
        if (isProjectView) {
            return parseInt(t.projectId) === parseInt(state.currentProject);
        }
        // If Geral: Match Date Only (Today)
        else {
            return t.date === viewDateStr;
        }
    });

    elements.todoList.innerHTML = '';
    elements.taskCount.textContent = `${visibleTasks.filter(t => !t.completed).length} tarefas`;

    const todayStr = getLocalISODate(new Date());
    const isToday = viewDateStr === todayStr;

    if (!isProjectView) {
        const dateLabel = isToday ? '' : `(${state.viewDate.toLocaleDateString('pt-BR')})`;
        elements.sectionTitle.textContent = 'Geral - Hoje ' + dateLabel;
    } else {
        const proj = state.projects.find(p => p.id === state.currentProject);
        elements.sectionTitle.textContent = `${proj ? proj.name : 'Projeto'} - Todas as Tarefas`;
    }

    if (visibleTasks.length === 0) {
        elements.todoList.innerHTML = `<div class="empty-state"><p style="text-align:center; color:#888;">Nada por aqui.</p></div>`;
        return;
    }

    // Sort: 
    // 1. Incompleted First
    // 2. Date Ascending (so past/today/future are ordered in Project View)
    visibleTasks.sort((a, b) => {
        if (a.completed !== b.completed) return a.completed - b.completed;
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return b.id - a.id;
    });

    visibleTasks.forEach(task => {
        const proj = state.projects.find(p => p.id === task.projectId) || state.projects[0];
        const el = document.createElement('div');

        // Add frequency class
        let freqClass = '';
        if (task.frequency) freqClass = `task-${task.frequency}`;

        el.className = `task-item ${task.completed ? 'task-done' : ''} ${freqClass}`;

        // Tags
        let tagsHtml = `<span class="project-tag">${proj.emoji} ${proj.name}</span>`;
        if (task.fromRoutine) tagsHtml += `<span class="tag-routine" style="font-size: 0.7rem;">üîÑ</span>`;
        if (isProjectView) {
            // In Project View, show the task Date since we see all dates
            const tDate = new Date(task.date + 'T12:00:00'); // Safe parse
            tagsHtml += `<span style="font-size:0.75rem; color:#666; margin-left:6px;">üìÖ ${tDate.toLocaleDateString('pt-BR')}</span>`;
        }

        el.innerHTML = `
            <div class="task-check ${task.completed ? 'checked' : ''}" role="checkbox"></div>
            <div class="task-content">
                <div class="task-title">${task.title}</div>
                 <div style="margin-top:4px;">${tagsHtml}</div>
                ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
            </div>
            <div class="task-actions">
                <button class="edit-btn" style="border:none; background:none; color:#2E7D32; margin-right:8px;">‚úé</button>
                <button class="delete-btn" style="border:none; background:none; color:#ccc;">&times;</button>
            </div>
        `;
        el.querySelector('.task-check').addEventListener('click', (e) => { e.stopPropagation(); toggleTask(task.id); });
        el.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); editTask(task.id); });
        el.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); });
        elements.todoList.appendChild(el);
    });
}

function renderDate() {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const dateStr = state.viewDate.toLocaleDateString('pt-BR', options);

    // Check if viewDate is Today
    const viewDateISO = getLocalISODate(state.viewDate);
    const todayISO = getLocalISODate(new Date());
    const isToday = viewDateISO === todayISO;

    elements.dateDisplay.textContent = (isToday ? 'Hoje, ' : '') + dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

    const phase = getMoonPhase(state.viewDate);
    elements.moonPhaseDisplay.innerHTML = `<span title="${phase.name}">${phase.icon} ${phase.name}</span>`;

    elements.moonTipDisplay.innerHTML = `
        ${phase.tip} 
        <button id="learnMoreBtn" class="learn-more-link">(saber mais)</button>
    `;

    const learnMoreBtn = document.getElementById('learnMoreBtn');
    if (learnMoreBtn) {
        learnMoreBtn.addEventListener('click', () => openMoonModal(phase));
    }

    // Re-render tasks because date changed
    renderTasks();
}

function changeDate(days) {
    const newDate = new Date(state.viewDate);
    newDate.setDate(newDate.getDate() + days);
    state.viewDate = newDate;
    renderDate();
}

// Unified Save Function (Create or Update)
function saveTask(e) {
    e.preventDefault();
    const title = elements.inputs.title.value;
    const desc = elements.inputs.desc.value;
    const priority = elements.inputs.priority.value;
    const dateInput = elements.inputs.date.value || getLocalISODate(new Date());
    const freq = elements.inputs.freq.value;
    const projId = parseInt(elements.inputs.project.value);

    // Collect Week Days
    let daysOfWeek = [];
    if (freq === 'weekly') {
        document.querySelectorAll('.week-days-selector input:checked').forEach(cb => {
            daysOfWeek.push(parseInt(cb.value));
        });
    }

    // EDIT MODE
    if (state.editingId) {
        // Loose equality to handle ID number vs string
        const taskIndex = state.tasks.findIndex(t => t.id == state.editingId);
        if (taskIndex > -1) {
            state.tasks[taskIndex].title = title;
            state.tasks[taskIndex].description = desc;
            state.tasks[taskIndex].priority = priority;
            state.tasks[taskIndex].date = dateInput;
            state.tasks[taskIndex].projectId = projId;
            // Not updating frequency for existing single task
        }
    }
    // CREATE MODE
    else {
        if (freq !== 'none') {
            const newRoutine = {
                id: Date.now(),
                title,
                description: desc,
                frequency: freq,
                projectId: projId,
                nextRun: dateInput
            };
            if (freq === 'weekly' && daysOfWeek.length > 0) {
                newRoutine.daysOfWeek = daysOfWeek;
            }
            state.routines.push(newRoutine);
            processRoutines();
        } else {
            state.tasks.push({
                id: Date.now(),
                title,
                description: desc,
                date: dateInput,
                priority,
                projectId: projId,
                completed: false
            });
        }
    }

    saveData();
    elements.taskForm.reset();
    toggleModal(false);

    // Explicitly re-render locally to ensure UI reflects change immediately
    // If the date changed, we might need to update viewDate or just show success
    const currentViewISO = getLocalISODate(state.viewDate);
    if (currentViewISO === dateInput || state.currentProject !== 'all') {
        renderTasks();
    } else {
        renderTasks();
    }
}

function editTask(id) {
    const task = state.tasks.find(t => t.id === id);
    if (!task) return;

    state.editingId = id; // Set edit flag

    // Fill Form
    elements.inputs.title.value = task.title;
    elements.inputs.desc.value = task.description || '';
    elements.inputs.date.value = task.date;
    elements.inputs.priority.value = task.priority;
    elements.inputs.project.value = task.projectId;
    elements.inputs.freq.value = 'none'; // Editing single task

    // Reset and Hide Week Days in Edit Mode (since we only edit single task instance usually)
    const weekGroup = document.getElementById('weekDaysGroup');
    if (weekGroup) weekGroup.classList.add('hidden');
    document.querySelectorAll('.week-days-selector input').forEach(cb => cb.checked = false);

    elements.modal.querySelector('h2').textContent = 'Editar Tarefa';
    elements.modal.classList.add('visible');
}

function addProject(e) {
    e.preventDefault();
    const name = elements.inputs.projName.value;
    state.projects.push({
        id: Date.now(),
        name: name,
        emoji: selectedEmoji
    });
    saveData();
    renderProjects();

    // Switch to new project logic?
    state.currentProject = state.projects[state.projects.length - 1].id;
    renderProjects();
    renderTasks();

    elements.projectForm.reset();
    toggleProjectModal(false);
}

function toggleTask(id) {
    const task = state.tasks.find(t => t.id === id);
    if (task) { task.completed = !task.completed; saveData(); }
}

function deleteTask(id) {
    if (confirm('Excluir tarefa?')) {
        state.tasks = state.tasks.filter(t => t.id !== id);
        saveData();
    }
}

// Modals
function toggleModal(show) {
    if (show) {
        if (!state.editingId) {
            // New Task default setup
            const currentISO = getLocalISODate(state.viewDate);
            elements.inputs.date.value = currentISO;
            updateProjectSelect();
            elements.modal.querySelector('h2').textContent = 'Nova Tarefa';
            elements.taskForm.reset();
            // Manually reset date again after form reset
            elements.inputs.date.value = currentISO;
        }
        elements.modal.classList.add('visible');
    }
    else {
        elements.modal.classList.remove('visible');
        state.editingId = null; // Clear edit flag on close
    }
}

function toggleProjectModal(show) {
    if (show) elements.projectModal.classList.add('visible');
    else elements.projectModal.classList.remove('visible');
}

// Moon Helpers
function openMoonModal(phase) {
    elements.moonModalTitle.innerHTML = `${phase.icon} ${phase.name}`;
    elements.moonModalContent.innerHTML = getMoonContent(phase);
    // Bind buttons
    elements.moonModalContent.querySelectorAll('.btn-guide').forEach(btn => {
        btn.addEventListener('click', () => openGuideModal(btn.dataset.guide, phase));
    });
    elements.moonModal.classList.add('visible');
}

function getMoonContent(phase) {
    return `
        <p class="moon-detail-intro"><strong>Fase Atual:</strong> ${phase.name}</p>
        <div class="moon-detail-section">
            <div class="section-flex-header"><h4>üå± No Plantio</h4><button class="btn-guide" data-guide="planting">(saiba como)</button></div>
            <p>${phase.details.planting}</p>
        </div>
        <div class="moon-detail-section">
            <div class="section-flex-header"><h4>‚úÇÔ∏è Nas Podas</h4><button class="btn-guide" data-guide="pruning">(saiba como)</button></div>
            <p>${phase.details.pruning}</p>
        </div>
        <div class="moon-detail-section">
            <div class="section-flex-header"><h4>üçØ Na Colheita</h4><button class="btn-guide" data-guide="harvest">(saiba como)</button></div>
            <p>${phase.details.harvest}</p>
        </div>
    `;
}

function openGuideModal(type, phase) {
    renderGuideContent(type, phase);
}

const fullGuides = {
    planting: {
        nova: `<h3>üå± Plantio na Lua Nova</h3><p>Nesta fase, a seiva est√° concentrada nas ra√≠zes. √â um per√≠odo de "repouso" vis√≠vel.</p><ul><li><strong>O que evitar:</strong> Semear sementes delicadas.</li><li><strong>O que pode:</strong> Transplante de mudas.</li></ul>`,
        crescente: `<h3>üå± Plantio na Lua Crescente</h3><p>A seiva sobe. O crescimento √© acelerado!</p><ul><li><strong>O que plantar:</strong> Hortali√ßas de folha (alface, couve), milho, feij√£o.</li></ul>`,
        cheia: `<h3>üå± Plantio na Lua Cheia</h3><p>Energia na copa e flores.</p><ul><li><strong>Foco:</strong> Repolho, couve-flor.</li><li><strong>Aten√ß√£o:</strong> Evite podar.</li></ul>`,
        minguante: `<h3>üå± Plantio na Lua Minguante</h3><p>For√ßa nas ra√≠zes.</p><ul><li><strong>O que plantar:</strong> Batata, cenoura, mandioca.</li></ul>`
    },
    pruning: {
        nova: `<h3>‚úÇÔ∏è Poda na Lua Nova</h3><p>Poda de Limpeza.</p>`,
        crescente: `<h3>‚úÇÔ∏è Poda na Lua Crescente</h3><p>Estimula brota√ß√£o r√°pida. Evite em frut√≠feras.</p>`,
        cheia: `<h3>‚úÇÔ∏è Poda na Lua Cheia</h3><p>N√£o recomendado.</p>`,
        minguante: `<h3>‚úÇÔ∏è Poda na Lua Minguante</h3><p>Ideal para produ√ß√£o e cicatriza√ß√£o.</p>`
    },
    harvest: {
        nova: `<h3>üçØ Colheita na Lua Nova</h3><p>Madeiras e ra√≠zes de longa dura√ß√£o.</p>`,
        crescente: `<h3>üçØ Colheita na Lua Crescente</h3><p>Ervas arom√°ticas e medicinais.</p>`,
        cheia: `<h3>üçØ Colheita na Lua Cheia</h3><p>Frutas suculentas para consumo imediato.</p>`,
        minguante: `<h3>üçØ Colheita na Lua Minguante</h3><p>Ra√≠zes, milho e feij√£o para secar.</p>`
    }
};

function renderGuideContent(type, phase) {
    let phaseKey = 'nova';
    if (phase.name.includes('Crescente')) phaseKey = 'crescente';
    else if (phase.name.includes('Cheia')) phaseKey = 'cheia';
    else if (phase.name.includes('Minguante')) phaseKey = 'minguante';

    elements.guideModalTitle.textContent = 'Guia R√°pido';
    elements.guideModalContent.innerHTML = fullGuides[type][phaseKey] || '<p>Sem detalhes.</p>';
    elements.guideModal.classList.add('visible');
}

function getMoonPhase(date) {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    let c = 0, e = 0, jd = 0, b = 0;
    if (month < 3) { year--; month += 12; }
    ++c; c = 365.25 * year; e = 30.6 * (month + 1);
    jd = c + e + day - 694039.09; jd /= 29.5305882;
    b = parseInt(jd); jd -= b; b = Math.round(jd * 8);
    if (b >= 8) b = 0;

    const detailsNova = { planting: 'Foco nas ra√≠zes.', pruning: 'Podas de limpeza.', harvest: 'Ra√≠zes e madeiras.' };
    const detailsCrescente = { planting: 'Folhas e gr√£os.', pruning: 'Crescimento r√°pido.', harvest: 'Ervas e folhas.' };
    const detailsCheia = { planting: 'Transplantes.', pruning: 'N√£o recomendada.', harvest: 'Frutas suculentas.' };
    const detailsMinguante = { planting: 'Ra√≠zes e tub√©rculos.', pruning: 'Ideal para produ√ß√£o.', harvest: 'Gr√£os secos.' };

    const phases = [
        { name: 'Lua Nova', icon: 'üåë', tip: 'Limpeza e Ra√≠zes.', details: detailsNova },
        { name: 'Lua Crescente', icon: 'üåí', tip: 'Plantio de folhas.', details: detailsCrescente },
        { name: 'Quarto Crescente', icon: 'üåì', tip: 'Plantio de folhas.', details: detailsCrescente },
        { name: 'Crescente Gibosa', icon: 'üåî', tip: 'Feij√£o e milho.', details: detailsCrescente },
        { name: 'Lua Cheia', icon: 'üåï', tip: 'Colheita de frutas.', details: detailsCheia },
        { name: 'Minguante Gibosa', icon: 'üåñ', tip: 'Colheita de ra√≠zes.', details: detailsMinguante },
        { name: 'Quarto Minguante', icon: 'üåó', tip: 'Podas de produ√ß√£o.', details: detailsMinguante },
        { name: 'Lua Minguante', icon: 'üåò', tip: 'Podas de produ√ß√£o.', details: detailsMinguante }
    ];
    return phases[b];
}

// Event Listeners
function setupEventListeners() {
    if (elements.addBtn) elements.addBtn.addEventListener('click', () => toggleModal(true));
    if (elements.closeModal) elements.closeModal.addEventListener('click', () => toggleModal(false));
    if (elements.closeProjectModal) elements.closeProjectModal.addEventListener('click', () => toggleProjectModal(false));
    if (elements.closeMoonModal) elements.closeMoonModal.addEventListener('click', () => elements.moonModal.classList.remove('visible'));
    if (elements.closeGuideModal) elements.closeGuideModal.addEventListener('click', () => elements.guideModal.classList.remove('visible'));

    // Outside clicks
    if (elements.modal) elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) toggleModal(false); });
    if (elements.projectModal) elements.projectModal.addEventListener('click', (e) => { if (e.target === elements.projectModal) toggleProjectModal(false); });

    if (elements.prevMoonBtn) elements.prevMoonBtn.addEventListener('click', () => changeDate(-1));
    if (elements.nextMoonBtn) elements.nextMoonBtn.addEventListener('click', () => changeDate(1));

    // Toggle Week Days
    const freqSelect = document.getElementById('taskFreq');
    if (freqSelect) {
        freqSelect.addEventListener('change', (e) => {
            const group = document.getElementById('weekDaysGroup');
            if (group) {
                if (e.target.value === 'weekly') {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            }
        });
    }

    if (elements.taskForm) elements.taskForm.addEventListener('submit', saveTask);
    if (elements.projectForm) elements.projectForm.addEventListener('submit', addProject);

    // Emoji Selection
    document.querySelectorAll('.emoji-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedEmoji = e.target.textContent;
        });
    });
}

init();
